---
title: "Stanford Center for Ocean Solutions"
subtitle: "Practical Assessment for a Research Data Analyst"
author: "Althea Marks"
date: 2022-09-08
date-format: long
format:
  html:
    toc: true
    toc-location: left
    code-overflow: wrap
execute:
  warning: false
editor_options: 
  chunk_output_type: console
---

## Purpose

This Practical Assessment for recruitment of the Research Data Analyst is intended to be a self-guided exercise based on the information provided. Please review the information from the three csv files included in the "data" folder as well as the assessment questions below and reply with your submission by or before the time noted via the corresponding email.

## Read in Data

```{r setup}
# create data directory path
data_path <- file.path("data")

# create output pathway
out_path <- dir.create("output") 

# read in data
vessel_assess <- read.csv(file = file.path(data_path, 
                                           "GFWVesselAssessment.csv"),
                          na.strings=c("","NA"))
port_visit_peru <- read.csv(file = file.path(data_path, 
                                             "port_visit_peru.csv"),
                            na.strings=c("","NA"))
vessel_info <- read.csv(file = file.path(data_path, 
                                         "vessel_information.csv"),
                        na.strings=c("","NA"))
```

```{r packages}
# load required libraries
library(tidyverse) # wrangling and visualizing
library(magrittr) # pipe function
library(knitr) # rendering this quarto doc
library(rvest) # webscraping
library(lubridate) # dates and time
library(viridis) # color blind color palett
library(forcats) # wroking with factors
library(scales) # changing graph scales
```

`vessel_assess` summarizes vessel information:

-   `Vessel.Name` name of vessel
-   `IMO` vessel number (International Maritime Organization)
-   `Flag` country of the vessel flag

`port_visit_peru` summarizes port visit events by maritime vessels in Peru (ISO3 code: PER) from 2020 to 2022

-   `ssvid` vessel identity (Maritime Mobile Service Identity)
-   `timestamp` time of the visit
-   `label` port name
-   `lat` latitude of the port
-   `lon` longitude of the port

`vessel_info` summarizes vessel information

-   `ssvid` vessel identity (Maritime Mobile Service Identity)
-   `flag`: ISO3 code of the vessel flag (i.e., country where a vessel is under jurisdiction)
-   `vessel_class` fishing, carrier vessels, bunker vessels, etc.
-   `gear_type` type of fishing gear for fishing vessels

## Assessment Questions

### Familiarity with Content

The initial assessment content focuses on the candidate's existing familiarity with the relevant content of interest, or the ability to quickly familiarize oneself with new content and terminology.

Using `vessel_assess`:

1.  Which vessels (if any) are listed as IUU (ilegal, unreported and unregulated) vessels ([Combined IUU Vessel List](https://www.iuu-vessels.org/))
    -   For each vessel listed as an IUU vessel: state the Regional Fisheries Management Organization (RFMO) for which the vessel is IUU listed.

```{r question_1}

# read in IUU list 
iuu_list <- read.csv(file.path(data_path, "IUU_list.csv"), 
                     na.strings=c("","NA")) # replace blank cells with NAs

# remove NA rows and columns
vessel_assess %<>%
  drop_na(Vessel.Name) %>% 
  select(1:3)

# check values of column
unique(iuu_list$CurrentlyListed)

# filter vessels by currently listed
iuu_list_current <- iuu_list %>% 
  filter(CurrentlyListed == "True") %>% 
  select(3:4) # remove unneeded columns for join
  
# which vessels in `vessel_assess` is listed in `iuu_list_current` match by IMO
iuu_vessels <- vessel_assess %>% 
  inner_join(iuu_list_current, by = "IMO") # pull RFMO column over

# display results
knitr::kable(iuu_vessels, 
             align = "lll", 
             caption = "Vessels Currently Listed as IUU Vessels",
             col.names = gsub("[.]", " ", names(iuu_vessels)))
```

3.  Using resources available online, which vessels (if any) have flags that have been identified as Flags of Convenience?
    -   Please provide the citation for where you found this information

```{r question_2}
# scrape table from ITF Seafarers (International Transport Workers Federation)
itf_foc <- read_html("https://www.itfseafarers.org/en/focs/current-registries-listed-as-focs") %>% 
  html_node(xpath = "/html/body/div[1]/div/div[2]/main/div[2]/div/div/div[3]/article/div/div[1]/ul") %>% 
  html_elements("li") %>% 
  html_text2() %>% 
  as_tibble() %>% 
  rename("Flag" = value) # name variable column

# vessels with flags that match in ITF FOC list
foc_vessels <- vessel_assess %>% 
  semi_join(itf_foc, by = "Flag")

# table for html doc
knitr::kable(foc_vessels,
             align = "lll", 
             caption = "Vessels with Flags of Convience",
             col.names = gsub("[.]", " ", names(foc_vessels)))

```

Citation for FOC list:

"Current Registries Listed as FOCs". *ITF Seafarers*, <https://www.itfseafarers.org/en/focs/current-registries-listed-as-focs>. London: International Transport Workers' Federation. Accessed 7 Sept. 2022.

### Analysis Techniques

The secondary assessment content focuses on the candidate's approach to analysis techniques and communication methods.

Using `port_visit_peru` and `vessel_info`:

4.  For each port in 2021: calculate the proportion of the number of foreign fishing vessel visits over the number of all vessel visits by fishing vessels of any gear type.

    -   Include blank `gear_type` cells and exclude blank `flag` cells.
    -   "foreign vessel visit" means the port visit by vessels whose flag state is different from the port state.

```{r question_3}
# check values of vessel class
unique(vessel_info$vessel_class)

# remove blank flag rows and non-fishing vessels
vessel_info_2 <- vessel_info %>%
  filter(vessel_class == "fishing")

# filter and combine dataframes
peru_fishves_2021 <- port_visit_peru %>% 
  mutate("timestamp" = ymd_hms(timestamp)) %>% # convert time to ymdhms
  filter(year(timestamp) == "2021") %>% # only use 2021 observations
  left_join(vessel_info_2, by = "ssvid") %>% # match to vessel info by ssvid
  filter(!is.na(flag)) # remove NA flag rows

# summary table with proportion of foreign fishing vessels / all fishing vessels
peru_fishves_2021_sum <- peru_fishves_2021 %>% 
  group_by(label) %>% # results by each port
  summarise(n_foreign = sum(flag != "PER"), # n foriegn flag observations
            n_all = length(flag), # n total flag observations
            prop_foreign_vessels = round(n_foreign/n_all, 
                                     digits = 3)) # calculate proportion

knitr::kable(peru_fishves_2021_sum,
             col.names = gsub("[_]", " ", names(peru_fishves_2021_sum)),
             caption = "The Proportion of Foriegn Fishing Vessels by Peruvian Ports 2021")
```

5.  Among ports that received more than 10 visits by fishing vessels of any gear type (including blank `gear_type`) in 2021, plot the top 10 ports that received the highest proportions of foreign vessel visits (choose any plot format that you think is appropriate and best visualizes the patterns).

```{r question_4}
# ports with more than 10 fishing vessel visits
top_10_prop <- peru_fishves_2021_sum %>% # blank gear_type included here
  filter(n_all > 10) %>% 
  arrange(desc(prop_foreign_vessels)) %>% # sort highest to lowest
  filter(prop_foreign_vessels == prop_foreign_vessels[1:10]) %>%  # top 10
  mutate(label = factor(label), # label variable as factor
         label = fct_reorder(label, prop_foreign_vessels)) # reorder factor by prop

graph_top_10 <- top_10_prop %>% 
  ggplot(aes(prop_foreign_vessels, label)) + 
  geom_col(aes(fill = label)) + # bar graph
  theme_classic() + # clean theme
  scale_fill_viridis(discrete = TRUE, option = "G") + # color blind friendly 
  scale_x_continuous(labels = scales::percent, # axis in percent
                     limits = c(0,1)) + # expand x axis to 100%
  theme(legend.position="none", # remove legend
        axis.title.y = element_blank()) + # remove y axis title
  labs(x = "Proportion of Foreign Fishing Vessel Visits",
       title = "Peruvian Ports with Highest Foreign Fishing Vessel Visits",
       subtitle = "2021 Ports with over 10 visits")

graph_top_10
```

6.  Submit a summary of the steps you took so that we can follow your logic (for example annotated script, Jupyter Notebook, R Markdown, or any format of your choice).
